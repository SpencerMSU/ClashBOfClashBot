# All Clans Importer - Импортер данных войн из ВСЕХ кланов

## Описание
All Clans Importer - это улучшенная версия импортера, которая сканирует **АБСОЛЮТНО ВСЕ** кланы во всех регионах без ограничений. В отличие от стандартного импортера, который ограничивается топ-10000 кланов, этот импортер обрабатывает максимально возможное количество кланов из каждой локации.

## Основные отличия от war_importer

| Характеристика | war_importer | all_importer |
|----------------|--------------|--------------|
| Количество кланов | До 10,000 на локацию | Все доступные (без ограничений) |
| Количество локаций | 20 основных | 200+ всех возможных |
| Механизм пагинации | Простой с фиксированным лимитом | Расширенный с повторными попытками |
| Обработка ошибок | Базовая | Улучшенная с retry логикой |
| Цель | Быстрый импорт топ-кланов | Полное сканирование всех кланов |

## Возможности
- **Полное сканирование** - обрабатывает ВСЕ доступные кланы в каждой локации
- **200+ локаций** - включает все страны, регионы и международные зоны
- **Умная пагинация** - автоматически определяет конец списка кланов
- **Повторные попытки** - retry логика при ошибках API
- **Обработка пропусков** - продолжает сканирование даже если API пропускает offset-ы
- Обработка всех завершенных войн из журнала войн каждого клана
- Автоматическое сохранение данных в базу данных
- Защита от дублирования - войны, которые уже есть в БД, пропускаются
- Детальное логирование всех операций
- Статистика по итогам импорта

## Требования
- Python 3.8+
- Установленные зависимости из requirements.txt
- Токен API Clash of Clans (получить на https://developer.clashofclans.com)

## Настройка

### 1. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 2. Настройка API токена
Создайте файл `api_tokens.txt` в корневой директории проекта со следующим содержимым:
```
COC_API_TOKEN=ваш_токен_api_clash_of_clans
```

Или установите переменную окружения:
```bash
export COC_API_TOKEN=ваш_токен_api_clash_of_clans
```

## Запуск

### Запуск программы
```bash
python3 all_importer.py
```

Программа начнет:
1. Инициализацию базы данных
2. Сканирование ВСЕХ кланов из ВСЕХ 200+ локаций
3. Получение журнала войн каждого клана
4. Импорт всех завершенных войн в базу данных

### Логирование
Все операции логируются в:
- Консоль (stdout)
- Файл `all_importer.log`

Ошибки API сохраняются в файл `all_clans_api_errors.json`

## Обработанные локации

### Континентальные регионы (7)
- Europe, North America, South America, Asia, Australia, Africa, International

### Крупнейшие страны (20+)
- Russia, China, India, Germany, United States, United Kingdom, Canada, France, Spain, Italy, Brazil, Japan, South Korea, Turkey, Poland, Indonesia, Thailand, Netherlands и другие

### Полный список
Программа обрабатывает **более 200 локаций**, включая:
- Все страны Европы (45+)
- Все страны Азии (50+)
- Все страны Америки (35+)
- Все страны Африки (55+)
- Все страны Океании (15+)
- Все международные зоны

Полный список можно найти в коде `all_importer.py` в переменной `self.location_ids`.

## Умная пагинация

All Clans Importer использует улучшенный механизм пагинации:

1. **Отсутствие жестких лимитов** - не ограничивается 10,000 кланами
2. **Обработка пропусков** - если API пропускает offset, продолжает поиск дальше
3. **Retry логика** - до 3 попыток при ошибках
4. **Автоопределение конца** - останавливается только после двух подряд пустых ответов
5. **Паузы между запросами** - предотвращает перегрузку API

## Данные, которые импортируются

Для каждой войны сохраняются:
- Время окончания войны
- Название клана-противника
- Размер команды (teamSize)
- Количество звезд обеих команд
- Процент разрушения обеих команд
- Количество использованных атак
- Результат войны (win/lose/tie)

## Производительность

**Примерное время выполнения:**
- Для 10 локаций: ~1-2 часа
- Для 50 локаций: ~5-10 часов
- Для всех 200+ локаций: ~20-40 часов

**Примерное количество данных:**
- Кланов: 50,000 - 200,000+
- Войн: 500,000 - 2,000,000+

*Время и объем зависят от скорости API и количества доступных данных*

## Статистика

По завершении работы программа выведет:
- Время выполнения
- Количество проверенных кланов
- Количество импортированных войн
- Количество пропущенных войн (дубликаты)
- Количество ошибок

## Пример вывода
```
================================================================================
ЗАПУСК ПОЛНОГО ИМПОРТА ВОЙН ИЗ ВСЕХ КЛАНОВ
================================================================================
Инициализация базы данных...
База данных инициализирована
Будет проверено локаций: 245
СКАНИРОВАНИЕ ВСЕХ КЛАНОВ БЕЗ ОГРАНИЧЕНИЙ
================================================================================

================================================================================
ИМПОРТ ПО ВСЕМ ЛОКАЦИЯМ
================================================================================

Обработка локации 32000007...
  Offset 0: Получено 1000 кланов (всего: 1000)
  Offset 1000: Получено 1000 кланов (всего: 2000)
  Offset 2000: Получено 1000 кланов (всего: 3000)
  ...
  Offset 15000: Получено 342 кланов (всего: 15342)
  Достигнут конец списка кланов для локации 32000007
ВСЕГО найдено 15342 кланов в локации 32000007
  [1/15342] Обработка клана: Example Clan (#ABC123)
    Найдено 10 войн в журнале
      ✓ Война импортирована: vs Enemy Clan (win) - 20231201T120000.000Z
...

================================================================================
ПОЛНЫЙ ИМПОРТ ЗАВЕРШЕН
================================================================================
Время выполнения: 25:34:12
Всего кланов проверено: 187,543
Уникальных кланов обработано: 178,234
Войн импортировано: 1,234,567
Войн пропущено (уже в БД): 45,678
Ошибок: 234
================================================================================
```

## Важные примечания

### Осторожное использование
**ВНИМАНИЕ:** Этот импортер выполняет очень большое количество запросов к API (сотни тысяч). Это может:
- Занять много времени (до 40+ часов для полного сканирования)
- Привести к временной блокировке вашего IP при слишком частых запросах
- Потребовать значительные ресурсы сервера

### Рекомендации
1. **Запускайте на выделенном сервере** - не на локальной машине
2. **Проверьте лимиты API** - убедитесь, что ваш токен позволяет большое количество запросов
3. **Используйте экранирование** - запускайте в screen/tmux для долгих сессий
4. **Мониторьте прогресс** - следите за логами для контроля процесса
5. **Начните с теста** - сначала попробуйте с несколькими локациями

### Альтернативы
Если вам нужен более быстрый импорт с меньшим количеством данных, используйте:
- `scanners/war_importer.py` - для импорта топ-10000 кланов
- `scanners/clan_scanner.py` - для непрерывного мониторинга топ-кланов

## Структура проекта

```
.
├── all_importer.py           # Импортер ВСЕХ кланов (этот файл)
├── scanners/                 # Директория со сканерами
│   ├── war_importer.py       # Стандартный импортер (топ-10k)
│   └── clan_scanner.py       # Непрерывный сканер
└── ...
```

## Техническая информация

### Отличия в реализации
1. **Расширенный список локаций** - 245 локаций вместо 20
2. **Улучшенная пагинация** - продолжает поиск даже при пропусках
3. **Retry механизм** - повторные попытки при ошибках
4. **Меньшие паузы** - 0.05s между кланами, 0.1s между offset-ами
5. **Отдельный лог файл** - `all_importer.log`
6. **Отдельный файл ошибок** - `all_clans_api_errors.json`

## Примечания
- Программа запускается единоразово, не является постоянным сервисом
- После завершения работы все импортированные данные доступны в базе данных
- Можно безопасно прервать программу с помощью Ctrl+C
- При повторном запуске войны, которые уже есть в БД, будут автоматически пропущены
- Программа автоматически пропускает уже обработанные кланы в пределах одной сессии
