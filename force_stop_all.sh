#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ ClashBot

echo "üõë –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ ClashBot..."

cd "$(dirname "$0")"

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Å ClashBot
echo "üîç –ü–æ–∏—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Python..."
PYTHON_PROCESSES=$(ps aux | grep -E "(main\.py|all_importer\.py)" | grep -v grep)

if [ -n "$PYTHON_PROCESSES" ]; then
    echo "üìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
    echo "$PYTHON_PROCESSES"
    echo ""
    
    # –ü–æ–ª—É—á–∞–µ–º PID –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    PIDS=$(ps aux | grep -E "(main\.py|all_importer\.py)" | grep -v grep | awk '{print $2}')
    
    for PID in $PIDS; do
        echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ $PID..."
        kill -TERM "$PID" 2>/dev/null
        
        # –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã
        sleep 3
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
        if kill -0 "$PID" 2>/dev/null; then
            echo "‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å $PID –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞..."
            kill -KILL "$PID" 2>/dev/null
            sleep 1
            
            if kill -0 "$PID" 2>/dev/null; then
                echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å $PID"
            else
                echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å $PID –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            fi
        else
            echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å $PID –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è"
        fi
    done
else
    echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å—ã Python –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
fi

# –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo ""
echo "üîì –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

if [ -f "clashbot.db" ]; then
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
    if command -v lsof >/dev/null 2>&1; then
        DB_LOCKS=$(lsof clashbot.db 2>/dev/null)
        if [ -n "$DB_LOCKS" ]; then
            echo "‚ö†Ô∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ –µ—â–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞:"
            echo "$DB_LOCKS"
            
            # –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å
            DB_PIDS=$(lsof -t clashbot.db 2>/dev/null)
            for PID in $DB_PIDS; do
                echo "üõë –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ë–î –æ—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞ $PID..."
                kill -KILL "$PID" 2>/dev/null
            done
        else
            echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–≤–æ–±–æ–¥–Ω–∞ –æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫"
        fi
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ WAL –∏ SHM (SQLite)
    if [ -f "clashbot.db-wal" ] || [ -f "clashbot.db-shm" ]; then
        echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ SQLite..."
        rm -f clashbot.db-wal clashbot.db-shm 2>/dev/null
        echo "‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã"
    fi
    
    # –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î
    echo "üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
    sqlite3 clashbot.db "SELECT COUNT(*) FROM sqlite_master;" >/dev/null 2>&1 && {
        echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞"
    } || {
        echo "‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞"
    }
else
    echo "‚ö†Ô∏è clashbot.db –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–Ω—è—Ç—ã"
echo "üéØ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç: python scripts/all_importer.py"