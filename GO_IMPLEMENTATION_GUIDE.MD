# üõ†Ô∏è ClashBot Go: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## üìã –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–æ–¥–∞

### üöÄ –≠—Ç–∞–ø 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

#### 1.1 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Go –º–æ–¥—É–ª—è
```bash
mkdir clashbot-go
cd clashbot-go
go mod init github.com/SpencerMSU/clashbot-go
```

#### 1.2 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
clashbot-go/
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ bot/
‚îÇ       ‚îî‚îÄ‚îÄ main.go                 # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.go              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.go                # –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ clan.go                # –ú–æ–¥–µ–ª—å –∫–ª–∞–Ω–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ war.go                 # –ú–æ–¥–µ–ª—å –≤–æ–π–Ω—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ subscription.go        # –ú–æ–¥–µ–ª—å –ø–æ–¥–ø–∏—Å–∫–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ building.go            # –ú–æ–¥–µ–ª—å –∑–¥–∞–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.go            # –°–µ—Ä–≤–∏—Å –ë–î
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrations.go          # –ú–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ repository/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ user.go            # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ clan.go            # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∫–ª–∞–Ω–æ–≤
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ war.go             # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤–æ–π–Ω
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ coc_api.go             # COC API –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram.go            # –¢–µ–ª–µ–≥—Ä–∞–º —Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment.go             # –ü–ª–∞—Ç–µ–∂–Ω—ã–π —Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ war_archiver.go        # –ê—Ä—Ö–∏–≤–∞—Ç–æ—Ä –≤–æ–π–Ω
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ building_monitor.go    # –ú–æ–Ω–∏—Ç–æ—Ä –∑–¥–∞–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ message.go             # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ callback.go            # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback'–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ commands.go            # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ keyboards.go           # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä
‚îÇ   ‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ bot.go                 # –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –±–æ—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ translations.go        # –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
‚îÇ       ‚îú‚îÄ‚îÄ validators.go          # –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã
‚îÇ       ‚îî‚îÄ‚îÄ formatting.go         # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ pkg/
‚îÇ   ‚îî‚îÄ‚îÄ logger/
‚îÇ       ‚îî‚îÄ‚îÄ logger.go              # –õ–æ–≥–≥–µ—Ä
‚îú‚îÄ‚îÄ configs/
‚îÇ   ‚îú‚îÄ‚îÄ config.yaml               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ config.example.yaml       # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îú‚îÄ‚îÄ 001_initial.sql           # –ù–∞—á–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ 002_premium_features.sql  # –ü—Ä–µ–º–∏—É–º —Ñ—É–Ω–∫—Ü–∏–∏
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îî‚îÄ‚îÄ api.md                    # API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ integration/              # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ unit/                     # –Æ–Ω–∏—Ç —Ç–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ go.mod
‚îú‚îÄ‚îÄ go.sum
‚îú‚îÄ‚îÄ Makefile
‚îú‚îÄ‚îÄ Dockerfile
‚îî‚îÄ‚îÄ docker-compose.yml
```

#### 1.3 –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (go.mod)
```go
module github.com/SpencerMSU/clashbot-go

go 1.21

require (
    github.com/go-telegram-bot-api/telegram-bot-api/v5 v5.5.1
    gorm.io/gorm v1.25.5
    gorm.io/driver/sqlite v1.5.4
    gorm.io/driver/postgres v1.5.4
    github.com/go-resty/resty/v2 v2.10.0
    github.com/spf13/viper v1.17.0
    github.com/sirupsen/logrus v1.9.3
    github.com/google/uuid v1.4.0
    golang.org/x/time v0.5.0
    github.com/stretchr/testify v1.8.4
)
```

#### 1.4 Makefile
```makefile
.PHONY: build run test clean lint

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
BINARY_NAME=clashbot-go
CMD_PATH=./cmd/bot

# –°–±–æ—Ä–∫–∞
build:
	go build -o bin/$(BINARY_NAME) $(CMD_PATH)

# –ó–∞–ø—É—Å–∫
run:
	go run $(CMD_PATH)/main.go

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test:
	go test -v ./...

test-coverage:
	go test -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out

# –õ–∏–Ω—Ç–∏–Ω–≥
lint:
	golangci-lint run

# –û—á–∏—Å—Ç–∫–∞
clean:
	rm -rf bin/
	rm -f coverage.out

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
deps:
	go mod download
	go mod tidy

# –ó–∞–ø—É—Å–∫ –≤ Docker
docker-build:
	docker build -t clashbot-go .

docker-run:
	docker-compose up -d

# –ú–∏–≥—Ä–∞—Ü–∏–∏
migrate-up:
	go run cmd/migrate/main.go up

migrate-down:
	go run cmd/migrate/main.go down
```

---

### üîß –≠—Ç–∞–ø 2: –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 2.1 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (internal/config/config.go)
```go
package config

import (
    "fmt"
    "os"
    "strings"
    
    "github.com/spf13/viper"
)

type Config struct {
    // Telegram Bot
    BotToken    string `mapstructure:"BOT_TOKEN"`
    BotUsername string `mapstructure:"BOT_USERNAME"`
    
    // Clash of Clans API
    COCAPIToken  string `mapstructure:"COC_API_TOKEN"`
    COCAPIBaseURL string `mapstructure:"COC_API_BASE_URL"`
    
    // Database
    DatabaseURL  string `mapstructure:"DATABASE_URL"`
    DatabasePath string `mapstructure:"DATABASE_PATH"`
    
    // YooKassa
    YooKassaShopID    string `mapstructure:"YOOKASSA_SHOP_ID"`
    YooKassaSecretKey string `mapstructure:"YOOKASSA_SECRET_KEY"`
    
    // Intervals
    ArchiveCheckInterval    int `mapstructure:"ARCHIVE_CHECK_INTERVAL"`
    DonationSnapshotInterval int `mapstructure:"DONATION_SNAPSHOT_INTERVAL"`
    
    // Server
    ServerPort string `mapstructure:"SERVER_PORT"`
    LogLevel   string `mapstructure:"LOG_LEVEL"`
}

var cfg *Config

func Load() (*Config, error) {
    viper.SetConfigName("config")
    viper.SetConfigType("yaml")
    viper.AddConfigPath("./configs/")
    
    // –ß–∏—Ç–∞–µ–º –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    viper.AutomaticEnv()
    
    // –ß–∏—Ç–∞–µ–º –∏–∑ —Ñ–∞–π–ª–∞ api_tokens.txt (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Python –≤–µ—Ä—Å–∏–µ–π)
    if err := readAPITokensFile(); err != nil {
        return nil, fmt.Errorf("failed to read api tokens: %w", err)
    }
    
    // –ß–∏—Ç–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ —Ñ–∞–π–ª
    if err := viper.ReadInConfig(); err != nil {
        if _, ok := err.(viper.ConfigFileNotFoundError); !ok {
            return nil, fmt.Errorf("failed to read config: %w", err)
        }
    }
    
    cfg = &Config{}
    if err := viper.Unmarshal(cfg); err != nil {
        return nil, fmt.Errorf("failed to unmarshal config: %w", err)
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    setDefaults(cfg)
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if err := validateConfig(cfg); err != nil {
        return nil, fmt.Errorf("config validation failed: %w", err)
    }
    
    return cfg, nil
}

func readAPITokensFile() error {
    file, err := os.Open("api_tokens.txt")
    if err != nil {
        return nil // –§–∞–π–ª –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
    }
    defer file.Close()
    
    content, err := os.ReadFile("api_tokens.txt")
    if err != nil {
        return err
    }
    
    lines := strings.Split(string(content), "\n")
    for _, line := range lines {
        line = strings.TrimSpace(line)
        if line == "" || strings.HasPrefix(line, "#") {
            continue
        }
        
        parts := strings.SplitN(line, "=", 2)
        if len(parts) == 2 {
            key := strings.TrimSpace(parts[0])
            value := strings.TrimSpace(parts[1])
            viper.Set(key, value)
        }
    }
    
    return nil
}

func setDefaults(cfg *Config) {
    if cfg.COCAPIBaseURL == "" {
        cfg.COCAPIBaseURL = "https://api.clashofclans.com/v1"
    }
    if cfg.DatabasePath == "" {
        cfg.DatabasePath = "clashbot.db"
    }
    if cfg.ArchiveCheckInterval == 0 {
        cfg.ArchiveCheckInterval = 900 // 15 –º–∏–Ω—É—Ç
    }
    if cfg.DonationSnapshotInterval == 0 {
        cfg.DonationSnapshotInterval = 21600 // 6 —á–∞—Å–æ–≤
    }
    if cfg.ServerPort == "" {
        cfg.ServerPort = "8080"
    }
    if cfg.LogLevel == "" {
        cfg.LogLevel = "info"
    }
}

func validateConfig(cfg *Config) error {
    if cfg.BotToken == "" {
        return fmt.Errorf("BOT_TOKEN is required")
    }
    if cfg.COCAPIToken == "" {
        return fmt.Errorf("COC_API_TOKEN is required")
    }
    return nil
}

func Get() *Config {
    if cfg == nil {
        panic("config not loaded")
    }
    return cfg
}
```

#### 2.2 –õ–æ–≥–≥–µ—Ä (pkg/logger/logger.go)
```go
package logger

import (
    "os"
    
    "github.com/sirupsen/logrus"
)

var log *logrus.Logger

func Init(level string) *logrus.Logger {
    log = logrus.New()
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Ä–æ–≤–Ω—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    logLevel, err := logrus.ParseLevel(level)
    if err != nil {
        logLevel = logrus.InfoLevel
    }
    log.SetLevel(logLevel)
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
    log.SetFormatter(&logrus.TextFormatter{
        FullTimestamp: true,
        ForceColors:   true,
    })
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã–≤–æ–¥–∞
    log.SetOutput(os.Stdout)
    
    return log
}

func Get() *logrus.Logger {
    if log == nil {
        return Init("info")
    }
    return log
}

// Convenience methods
func Info(args ...interface{}) {
    Get().Info(args...)
}

func Infof(format string, args ...interface{}) {
    Get().Infof(format, args...)
}

func Warn(args ...interface{}) {
    Get().Warn(args...)
}

func Warnf(format string, args ...interface{}) {
    Get().Warnf(format, args...)
}

func Error(args ...interface{}) {
    Get().Error(args...)
}

func Errorf(format string, args ...interface{}) {
    Get().Errorf(format, args...)
}

func Fatal(args ...interface{}) {
    Get().Fatal(args...)
}

func Fatalf(format string, args ...interface{}) {
    Get().Fatalf(format, args...)
}
```

---

### üóÑÔ∏è –≠—Ç–∞–ø 3: –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

#### 3.1 –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (internal/models/user.go)
```go
package models

import (
    "time"
    
    "gorm.io/gorm"
)

type User struct {
    TelegramID int64  `gorm:"primaryKey" json:"telegram_id"`
    PlayerTag  string `gorm:"not null;uniqueIndex" json:"player_tag"`
    CreatedAt  time.Time `json:"created_at"`
    UpdatedAt  time.Time `json:"updated_at"`
    
    // –°–≤—è–∑–∏
    Profiles      []UserProfile      `gorm:"foreignKey:TelegramID" json:"profiles"`
    Subscription  *Subscription      `gorm:"foreignKey:TelegramID" json:"subscription"`
    Notifications *NotificationSettings `gorm:"foreignKey:TelegramID" json:"notifications"`
    BuildingTrackers []BuildingTracker `gorm:"foreignKey:TelegramID" json:"building_trackers"`
}

type UserProfile struct {
    ID         uint   `gorm:"primaryKey" json:"id"`
    TelegramID int64  `gorm:"not null;index" json:"telegram_id"`
    PlayerTag  string `gorm:"not null" json:"player_tag"`
    ProfileName *string `json:"profile_name"`
    IsPrimary  bool   `gorm:"default:false" json:"is_primary"`
    CreatedAt  time.Time `json:"created_at"`
    
    // –°–≤—è–∑–∏
    User User `gorm:"foreignKey:TelegramID" json:"user"`
}

type NotificationSettings struct {
    TelegramID   int64 `gorm:"primaryKey" json:"telegram_id"`
    Enabled      bool  `gorm:"default:true" json:"enabled"`
    WarStart     bool  `gorm:"default:true" json:"war_start"`
    WarEnd       bool  `gorm:"default:true" json:"war_end"`
    AttackReminder bool `gorm:"default:true" json:"attack_reminder"`
    BuildingComplete bool `gorm:"default:false" json:"building_complete"` // –ü—Ä–µ–º–∏—É–º
    CustomTime   *string `json:"custom_time"` // –ü—Ä–µ–º–∏—É–º
    CreatedAt    time.Time `json:"created_at"`
    UpdatedAt    time.Time `json:"updated_at"`
    
    // –°–≤—è–∑–∏
    User User `gorm:"foreignKey:TelegramID" json:"user"`
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–≥–∞ –∏–≥—Ä–æ–∫–∞
func (u *User) ValidatePlayerTag() error {
    if len(u.PlayerTag) < 8 || len(u.PlayerTag) > 12 {
        return fmt.Errorf("invalid player tag length")
    }
    if !strings.HasPrefix(u.PlayerTag, "#") {
        u.PlayerTag = "#" + u.PlayerTag
    }
    return nil
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
func (u *User) IsPremium() bool {
    return u.Subscription != nil && u.Subscription.IsActive()
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
func (u *User) GetPrimaryProfile() *UserProfile {
    for _, profile := range u.Profiles {
        if profile.IsPrimary {
            return &profile
        }
    }
    return nil
}
```

#### 3.2 –ú–æ–¥–µ–ª—å –≤–æ–π–Ω (internal/models/war.go)
```go
package models

import (
    "time"
    
    "gorm.io/gorm"
)

type War struct {
    ID                uint      `gorm:"primaryKey" json:"id"`
    ClanTag          string    `gorm:"not null;index" json:"clan_tag"`
    OpponentTag      string    `gorm:"not null" json:"opponent_tag"`
    StartTime        time.Time `gorm:"not null" json:"start_time"`
    EndTime          time.Time `gorm:"not null;uniqueIndex" json:"end_time"`
    PreparationStartTime time.Time `gorm:"not null" json:"preparation_start_time"`
    TeamSize         int       `gorm:"not null" json:"team_size"`
    State            string    `gorm:"not null" json:"state"`
    Result           *string   `json:"result"`
    ClanStars        *int      `json:"clan_stars"`
    OpponentStars    *int      `json:"opponent_stars"`
    ClanDestruction  *float64  `json:"clan_destruction"`
    OpponentDestruction *float64 `json:"opponent_destruction"`
    WarData          string    `gorm:"type:text" json:"war_data"` // JSON –¥–∞–Ω–Ω—ã–µ –≤–æ–π–Ω—ã
    CreatedAt        time.Time `json:"created_at"`
    UpdatedAt        time.Time `json:"updated_at"`
    
    // –°–≤—è–∑–∏
    Attacks []Attack `gorm:"foreignKey:WarID" json:"attacks"`
}

type Attack struct {
    ID                uint      `gorm:"primaryKey" json:"id"`
    WarID            uint      `gorm:"not null;index" json:"war_id"`
    AttackerTag      string    `gorm:"not null" json:"attacker_tag"`
    DefenderTag      string    `gorm:"not null" json:"defender_tag"`
    Stars            int       `gorm:"not null" json:"stars"`
    DestructionPercentage float64 `gorm:"not null" json:"destruction_percentage"`
    Order            int       `gorm:"not null" json:"order"`
    Duration         int       `json:"duration"`
    AttackOrder      int       `json:"attack_order"`
    CreatedAt        time.Time `json:"created_at"`
    
    // –°–≤—è–∑–∏
    War War `gorm:"foreignKey:WarID" json:"war"`
}

type CWLSeason struct {
    ID            uint      `gorm:"primaryKey" json:"id"`
    ClanTag      string    `gorm:"not null;index" json:"clan_tag"`
    Season       string    `gorm:"not null" json:"season"`
    State        string    `gorm:"not null" json:"state"`
    CWLData      string    `gorm:"type:text" json:"cwl_data"` // JSON –¥–∞–Ω–Ω—ã–µ CWL
    CreatedAt    time.Time `json:"created_at"`
    UpdatedAt    time.Time `json:"updated_at"`
}

// –ú–µ—Ç–æ–¥—ã –¥–ª—è War
func (w *War) IsEnded() bool {
    return w.State == "warEnded"
}

func (w *War) IsInPreparation() bool {
    return w.State == "preparation"
}

func (w *War) IsInWar() bool {
    return w.State == "inWar"
}

func (w *War) GetWinner() string {
    if w.Result == nil {
        return "unknown"
    }
    return *w.Result
}
```

#### 3.3 –ú–æ–¥–µ–ª—å –ø–æ–¥–ø–∏—Å–æ–∫ (internal/models/subscription.go)
```go
package models

import (
    "time"
    
    "gorm.io/gorm"
)

type Subscription struct {
    ID          uint      `gorm:"primaryKey" json:"id"`
    TelegramID  int64     `gorm:"not null;uniqueIndex" json:"telegram_id"`
    Type        string    `gorm:"not null" json:"type"` // premium, proplus
    StartDate   time.Time `gorm:"not null" json:"start_date"`
    EndDate     time.Time `gorm:"not null" json:"end_date"`
    PaymentID   *string   `json:"payment_id"`
    Amount      float64   `json:"amount"`
    Currency    string    `gorm:"default:RUB" json:"currency"`
    Status      string    `gorm:"default:active" json:"status"` // active, cancelled, expired
    AutoRenew   bool      `gorm:"default:false" json:"auto_renew"`
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    
    // –°–≤—è–∑–∏
    User User `gorm:"foreignKey:TelegramID" json:"user"`
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏
func (s *Subscription) IsActive() bool {
    if s.Status != "active" {
        return false
    }
    return time.Now().Before(s.EndDate)
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
func (s *Subscription) IsExpired() bool {
    return time.Now().After(s.EndDate)
}

// –î–Ω–∏ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
func (s *Subscription) DaysUntilExpiry() int {
    if s.IsExpired() {
        return 0
    }
    duration := s.EndDate.Sub(time.Now())
    return int(duration.Hours() / 24)
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏
func (s *Subscription) GetProfileLimit() int {
    switch s.Type {
    case "premium":
        return 3
    case "proplus":
        return 5
    default:
        return 1
    }
}

func (s *Subscription) GetLinkedClanLimit() int {
    switch s.Type {
    case "premium":
        return 3
    case "proplus":
        return 10
    default:
        return 1
    }
}

func (s *Subscription) HasBuildingTracking() bool {
    return s.Type == "premium" || s.Type == "proplus"
}

func (s *Subscription) HasAdvancedNotifications() bool {
    return s.Type == "premium" || s.Type == "proplus"
}
```

---

### üåê –≠—Ç–∞–ø 4: API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

#### 4.1 Clash of Clans API –∫–ª–∏–µ–Ω—Ç (internal/services/coc_api.go)
```go
package services

import (
    "context"
    "encoding/json"
    "fmt"
    "net/http"
    "strings"
    "time"
    
    "github.com/go-resty/resty/v2"
    "golang.org/x/time/rate"
    
    "github.com/SpencerMSU/clashbot-go/internal/config"
    "github.com/SpencerMSU/clashbot-go/pkg/logger"
)

type COCAPIClient struct {
    client     *resty.Client
    baseURL    string
    apiToken   string
    rateLimiter *rate.Limiter
}

type Player struct {
    Tag                string `json:"tag"`
    Name               string `json:"name"`
    TownHallLevel     int    `json:"townHallLevel"`
    ExpLevel          int    `json:"expLevel"`
    Trophies          int    `json:"trophies"`
    BestTrophies      int    `json:"bestTrophies"`
    WarStars          int    `json:"warStars"`
    AttackWins        int    `json:"attackWins"`
    DefenseWins       int    `json:"defenseWins"`
    BuilderHallLevel  int    `json:"builderHallLevel"`
    Clan              *Clan  `json:"clan,omitempty"`
    Achievements      []Achievement `json:"achievements"`
    Troops            []Troop `json:"troops"`
    Heroes            []Hero  `json:"heroes"`
    Spells            []Spell `json:"spells"`
}

type Clan struct {
    Tag           string `json:"tag"`
    Name          string `json:"name"`
    Type          string `json:"type"`
    Description   string `json:"description"`
    Location      *Location `json:"location,omitempty"`
    BadgeUrls     BadgeUrls `json:"badgeUrls"`
    ClanLevel     int    `json:"clanLevel"`
    ClanPoints    int    `json:"clanPoints"`
    ClanVersusPoints int `json:"clanVersusPoints"`
    RequiredTrophies int `json:"requiredTrophies"`
    WarFrequency  string `json:"warFrequency"`
    WarWinStreak  int    `json:"warWinStreak"`
    WarWins       int    `json:"warWins"`
    WarTies       int    `json:"warTies"`
    WarLosses     int    `json:"warLosses"`
    IsWarLogPublic bool  `json:"isWarLogPublic"`
    Members       int    `json:"members"`
    MemberList    []ClanMember `json:"memberList,omitempty"`
}

type ClanMember struct {
    Tag                string `json:"tag"`
    Name               string `json:"name"`
    Role               string `json:"role"`
    ExpLevel           int    `json:"expLevel"`
    League             *League `json:"league,omitempty"`
    Trophies           int    `json:"trophies"`
    ClanRank           int    `json:"clanRank"`
    PreviousClanRank   int    `json:"previousClanRank"`
    Donations          int    `json:"donations"`
    DonationsReceived  int    `json:"donationsReceived"`
}

type WarLog struct {
    Items []WarLogEntry `json:"items"`
    Paging Paging       `json:"paging,omitempty"`
}

type WarLogEntry struct {
    Result           string    `json:"result"`
    EndTime          string    `json:"endTime"`
    TeamSize         int       `json:"teamSize"`
    Clan             WarClan   `json:"clan"`
    Opponent         WarClan   `json:"opponent"`
}

type CurrentWar struct {
    State                string    `json:"state"`
    TeamSize             int       `json:"teamSize"`
    PreparationStartTime string    `json:"preparationStartTime"`
    StartTime            string    `json:"startTime"`
    EndTime              string    `json:"endTime"`
    Clan                 WarClan   `json:"clan"`
    Opponent             WarClan   `json:"opponent"`
}

type WarClan struct {
    Tag            string      `json:"tag"`
    Name           string      `json:"name"`
    BadgeUrls      BadgeUrls   `json:"badgeUrls"`
    ClanLevel      int         `json:"clanLevel"`
    Attacks        int         `json:"attacks"`
    Stars          int         `json:"stars"`
    DestructionPercentage float64 `json:"destructionPercentage"`
    Members        []WarMember `json:"members"`
}

type WarMember struct {
    Tag                string   `json:"tag"`
    Name               string   `json:"name"`
    MapPosition        int      `json:"mapPosition"`
    TownhallLevel      int      `json:"townhallLevel"`
    OpponentAttacks    int      `json:"opponentAttacks"`
    BestOpponentAttack *Attack  `json:"bestOpponentAttack,omitempty"`
    Attacks            []Attack `json:"attacks,omitempty"`
}

type Attack struct {
    Order                int     `json:"order"`
    AttackerTag          string  `json:"attackerTag"`
    DefenderTag          string  `json:"defenderTag"`
    Stars                int     `json:"stars"`
    DestructionPercentage float64 `json:"destructionPercentage"`
    Duration             int     `json:"duration"`
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
type Achievement struct {
    Name           string `json:"name"`
    Stars          int    `json:"stars"`
    Value          int    `json:"value"`
    Target         int    `json:"target"`
    Info           string `json:"info"`
    CompletionInfo string `json:"completionInfo"`
    Village        string `json:"village"`
}

type Troop struct {
    Name     string `json:"name"`
    Level    int    `json:"level"`
    MaxLevel int    `json:"maxLevel"`
    Village  string `json:"village"`
}

type Hero struct {
    Name     string `json:"name"`
    Level    int    `json:"level"`
    MaxLevel int    `json:"maxLevel"`
    Village  string `json:"village"`
}

type Spell struct {
    Name     string `json:"name"`
    Level    int    `json:"level"`
    MaxLevel int    `json:"maxLevel"`
    Village  string `json:"village"`
}

type Location struct {
    ID          int    `json:"id"`
    Name        string `json:"name"`
    IsCountry   bool   `json:"isCountry"`
    CountryCode string `json:"countryCode"`
}

type League struct {
    ID   int       `json:"id"`
    Name string    `json:"name"`
    IconUrls IconUrls `json:"iconUrls"`
}

type BadgeUrls struct {
    Small  string `json:"small"`
    Large  string `json:"large"`
    Medium string `json:"medium"`
}

type IconUrls struct {
    Small string `json:"small"`
    Tiny  string `json:"tiny"`
}

type Paging struct {
    Cursors Cursors `json:"cursors"`
}

type Cursors struct {
    After  string `json:"after,omitempty"`
    Before string `json:"before,omitempty"`
}

func NewCOCAPIClient(cfg *config.Config) *COCAPIClient {
    client := resty.New()
    client.SetBaseURL(cfg.COCAPIBaseURL)
    client.SetHeader("Authorization", "Bearer "+cfg.COCAPIToken)
    client.SetHeader("Content-Type", "application/json")
    client.SetTimeout(30 * time.Second)
    
    // Rate limiter: 30 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É (–ª–∏–º–∏—Ç Supercell)
    rateLimiter := rate.NewLimiter(rate.Limit(30), 1)
    
    return &COCAPIClient{
        client:      client,
        baseURL:     cfg.COCAPIBaseURL,
        apiToken:    cfg.COCAPIToken,
        rateLimiter: rateLimiter,
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
func (c *COCAPIClient) GetPlayer(ctx context.Context, playerTag string) (*Player, error) {
    if err := c.rateLimiter.Wait(ctx); err != nil {
        return nil, fmt.Errorf("rate limiter error: %w", err)
    }
    
    playerTag = FormatPlayerTag(playerTag)
    encodedTag := strings.ReplaceAll(playerTag, "#", "%23")
    
    var player Player
    resp, err := c.client.R().
        SetContext(ctx).
        SetResult(&player).
        Get(fmt.Sprintf("/players/%s", encodedTag))
    
    if err != nil {
        return nil, fmt.Errorf("failed to get player: %w", err)
    }
    
    if resp.StatusCode() != http.StatusOK {
        return nil, fmt.Errorf("API error: %d - %s", resp.StatusCode(), resp.String())
    }
    
    return &player, nil
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∞–Ω–∞
func (c *COCAPIClient) GetClan(ctx context.Context, clanTag string) (*Clan, error) {
    if err := c.rateLimiter.Wait(ctx); err != nil {
        return nil, fmt.Errorf("rate limiter error: %w", err)
    }
    
    clanTag = FormatClanTag(clanTag)
    encodedTag := strings.ReplaceAll(clanTag, "#", "%23")
    
    var clan Clan
    resp, err := c.client.R().
        SetContext(ctx).
        SetResult(&clan).
        Get(fmt.Sprintf("/clans/%s", encodedTag))
    
    if err != nil {
        return nil, fmt.Errorf("failed to get clan: %w", err)
    }
    
    if resp.StatusCode() != http.StatusOK {
        return nil, fmt.Errorf("API error: %d - %s", resp.StatusCode(), resp.String())
    }
    
    return &clan, nil
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–ª–∞–Ω–∞
func (c *COCAPIClient) GetClanMembers(ctx context.Context, clanTag string) ([]ClanMember, error) {
    clan, err := c.GetClan(ctx, clanTag)
    if err != nil {
        return nil, err
    }
    
    return clan.MemberList, nil
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –≤–æ–π–Ω—ã –∫–ª–∞–Ω–∞
func (c *COCAPIClient) GetClanCurrentWar(ctx context.Context, clanTag string) (*CurrentWar, error) {
    if err := c.rateLimiter.Wait(ctx); err != nil {
        return nil, fmt.Errorf("rate limiter error: %w", err)
    }
    
    clanTag = FormatClanTag(clanTag)
    encodedTag := strings.ReplaceAll(clanTag, "#", "%23")
    
    var war CurrentWar
    resp, err := c.client.R().
        SetContext(ctx).
        SetResult(&war).
        Get(fmt.Sprintf("/clans/%s/currentwar", encodedTag))
    
    if err != nil {
        return nil, fmt.Errorf("failed to get current war: %w", err)
    }
    
    if resp.StatusCode() != http.StatusOK {
        return nil, fmt.Errorf("API error: %d - %s", resp.StatusCode(), resp.String())
    }
    
    return &war, nil
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–≥–∞ –≤–æ–π–Ω –∫–ª–∞–Ω–∞
func (c *COCAPIClient) GetClanWarLog(ctx context.Context, clanTag string, limit int) (*WarLog, error) {
    if err := c.rateLimiter.Wait(ctx); err != nil {
        return nil, fmt.Errorf("rate limiter error: %w", err)
    }
    
    clanTag = FormatClanTag(clanTag)
    encodedTag := strings.ReplaceAll(clanTag, "#", "%23")
    
    var warLog WarLog
    resp, err := c.client.R().
        SetContext(ctx).
        SetQueryParam("limit", fmt.Sprintf("%d", limit)).
        SetResult(&warLog).
        Get(fmt.Sprintf("/clans/%s/warlog", encodedTag))
    
    if err != nil {
        return nil, fmt.Errorf("failed to get war log: %w", err)
    }
    
    if resp.StatusCode() != http.StatusOK {
        return nil, fmt.Errorf("API error: %d - %s", resp.StatusCode(), resp.String())
    }
    
    return &warLog, nil
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–≥–æ–≤
func ValidatePlayerTag(tag string) error {
    if len(tag) < 8 || len(tag) > 12 {
        return fmt.Errorf("player tag must be 8-12 characters long")
    }
    
    tag = strings.ToUpper(strings.TrimPrefix(tag, "#"))
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã
    for _, char := range tag {
        if !((char >= '0' && char <= '9') || 
             (char >= 'A' && char <= 'Z') || 
             char == 'O' || char == 'I') {
            return fmt.Errorf("invalid characters in player tag")
        }
    }
    
    return nil
}

func ValidateClanTag(tag string) error {
    if len(tag) < 8 || len(tag) > 12 {
        return fmt.Errorf("clan tag must be 8-12 characters long")
    }
    
    tag = strings.ToUpper(strings.TrimPrefix(tag, "#"))
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã
    for _, char := range tag {
        if !((char >= '0' && char <= '9') || 
             (char >= 'A' && char <= 'Z') || 
             char == 'O' || char == 'I') {
            return fmt.Errorf("invalid characters in clan tag")
        }
    }
    
    return nil
}

func FormatPlayerTag(tag string) string {
    if !strings.HasPrefix(tag, "#") {
        tag = "#" + tag
    }
    return strings.ToUpper(tag)
}

func FormatClanTag(tag string) string {
    if !strings.HasPrefix(tag, "#") {
        tag = "#" + tag
    }
    return strings.ToUpper(tag)
}

func IsPlayerTag(tag string) bool {
    return ValidatePlayerTag(tag) == nil
}

func IsClanTag(tag string) bool {
    return ValidateClanTag(tag) == nil
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–æ–π–Ω—ã
func IsWarEnded(state string) bool {
    return state == "warEnded"
}

func IsWarInPreparation(state string) bool {
    return state == "preparation"
}

func IsWarInProgress(state string) bool {
    return state == "inWar"
}
```

---

### ü§ñ –≠—Ç–∞–ø 5: –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç

#### 5.1 –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –±–æ—Ç–∞ (internal/bot/bot.go)
```go
package bot

import (
    "context"
    "fmt"
    "os"
    "os/signal"
    "sync"
    "syscall"
    "time"
    
    tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
    "gorm.io/gorm"
    
    "github.com/SpencerMSU/clashbot-go/internal/config"
    "github.com/SpencerMSU/clashbot-go/internal/database"
    "github.com/SpencerMSU/clashbot-go/internal/handlers"
    "github.com/SpencerMSU/clashbot-go/internal/services"
    "github.com/SpencerMSU/clashbot-go/pkg/logger"
)

type Bot struct {
    api          *tgbotapi.BotAPI
    config       *config.Config
    db           *gorm.DB
    cocAPI       *services.COCAPIClient
    paymentService *services.PaymentService
    warArchiver  *services.WarArchiver
    buildingMonitor *services.BuildingMonitor
    
    messageHandler  *handlers.MessageHandler
    callbackHandler *handlers.CallbackHandler
    
    ctx    context.Context
    cancel context.CancelFunc
    wg     sync.WaitGroup
}

func New(cfg *config.Config) (*Bot, error) {
    // –°–æ–∑–¥–∞–µ–º Telegram bot API
    api, err := tgbotapi.NewBotAPI(cfg.BotToken)
    if err != nil {
        return nil, fmt.Errorf("failed to create bot API: %w", err)
    }
    
    logger.Infof("–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ %s", api.Self.UserName)
    
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    db, err := database.Connect(cfg)
    if err != nil {
        return nil, fmt.Errorf("failed to connect to database: %w", err)
    }
    
    // –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
    cocAPI := services.NewCOCAPIClient(cfg)
    paymentService := services.NewPaymentService(cfg)
    
    ctx, cancel := context.WithCancel(context.Background())
    
    bot := &Bot{
        api:            api,
        config:         cfg,
        db:             db,
        cocAPI:         cocAPI,
        paymentService: paymentService,
        ctx:            ctx,
        cancel:         cancel,
    }
    
    // –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    bot.messageHandler = handlers.NewMessageHandler(bot.db, bot.cocAPI, bot.paymentService)
    bot.callbackHandler = handlers.NewCallbackHandler(bot.db, bot.cocAPI, bot.paymentService)
    
    return bot, nil
}

func (b *Bot) Start() error {
    logger.Info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    if err := b.initComponents(); err != nil {
        return fmt.Errorf("failed to initialize components: %w", err)
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã
    b.startBackgroundServices()
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    u := tgbotapi.NewUpdate(0)
    u.Timeout = 60
    
    updates := b.api.GetUpdatesChan(u)
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    b.wg.Add(1)
    go func() {
        defer b.wg.Done()
        b.handleUpdates(updates)
    }()
    
    // –ñ–¥–µ–º —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    b.waitForShutdown()
    
    return nil
}

func (b *Bot) initComponents() error {
    // –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    if err := database.Migrate(b.db); err != nil {
        return fmt.Errorf("failed to run migrations: %w", err)
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Telegram API
    if _, err := b.api.GetMe(); err != nil {
        return fmt.Errorf("failed to connect to Telegram API: %w", err)
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—Ä—Ö–∏–≤–∞—Ç–æ—Ä –≤–æ–π–Ω
    b.warArchiver = services.NewWarArchiver(b.db, b.cocAPI, b.api)
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–Ω–∏—Ç–æ—Ä –∑–¥–∞–Ω–∏–π
    b.buildingMonitor = services.NewBuildingMonitor(b.db, b.cocAPI, b.api)
    
    return nil
}

func (b *Bot) startBackgroundServices() {
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Ä—Ö–∏–≤–∞—Ç–æ—Ä –≤–æ–π–Ω
    b.wg.Add(1)
    go func() {
        defer b.wg.Done()
        if err := b.warArchiver.Start(b.ctx); err != nil {
            logger.Errorf("War archiver error: %v", err)
        }
    }()
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä –∑–¥–∞–Ω–∏–π
    b.wg.Add(1)
    go func() {
        defer b.wg.Done()
        if err := b.buildingMonitor.Start(b.ctx); err != nil {
            logger.Errorf("Building monitor error: %v", err)
        }
    }()
}

func (b *Bot) handleUpdates(updates tgbotapi.UpdatesChannel) {
    for {
        select {
        case update := <-updates:
            b.processUpdate(update)
        case <-b.ctx.Done():
            return
        }
    }
}

func (b *Bot) processUpdate(update tgbotapi.Update) {
    defer func() {
        if r := recover(); r != nil {
            logger.Errorf("Panic while processing update: %v", r)
        }
    }()
    
    if update.Message != nil {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        if err := b.messageHandler.Handle(b.ctx, b.api, update); err != nil {
            logger.Errorf("Error handling message: %v", err)
        }
    } else if update.CallbackQuery != nil {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º callback –∑–∞–ø—Ä–æ—Å—ã
        if err := b.callbackHandler.Handle(b.ctx, b.api, update); err != nil {
            logger.Errorf("Error handling callback: %v", err)
        }
    }
}

func (b *Bot) waitForShutdown() {
    sigChan := make(chan os.Signal, 1)
    signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM)
    
    <-sigChan
    logger.Info("–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞...")
    
    b.Shutdown()
}

func (b *Bot) Shutdown() {
    logger.Info("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞...")
    
    // –û—Ç–º–µ–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    b.cancel()
    
    // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–æ—Ä—É—Ç–∏–Ω
    done := make(chan struct{})
    go func() {
        b.wg.Wait()
        close(done)
    }()
    
    select {
    case <-done:
        logger.Info("–í—Å–µ –≥–æ—Ä—É—Ç–∏–Ω—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã")
    case <-time.After(30 * time.Second):
        logger.Warn("–¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –≥–æ—Ä—É—Ç–∏–Ω")
    }
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    if b.paymentService != nil {
        b.paymentService.Close()
    }
    
    logger.Info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
func (b *Bot) SendMessage(chatID int64, text string, keyboard interface{}) error {
    msg := tgbotapi.NewMessage(chatID, text)
    msg.ParseMode = tgbotapi.ModeHTML
    
    if keyboard != nil {
        switch kb := keyboard.(type) {
        case tgbotapi.InlineKeyboardMarkup:
            msg.ReplyMarkup = kb
        case tgbotapi.ReplyKeyboardMarkup:
            msg.ReplyMarkup = kb
        }
    }
    
    _, err := b.api.Send(msg)
    return err
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
func (b *Bot) EditMessage(chatID int64, messageID int, text string, keyboard *tgbotapi.InlineKeyboardMarkup) error {
    msg := tgbotapi.NewEditMessageText(chatID, messageID, text)
    msg.ParseMode = tgbotapi.ModeHTML
    
    if keyboard != nil {
        msg.ReplyMarkup = keyboard
    }
    
    _, err := b.api.Send(msg)
    return err
}
```

#### 5.2 –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (cmd/bot/main.go)
```go
package main

import (
    "os"
    
    "github.com/SpencerMSU/clashbot-go/internal/bot"
    "github.com/SpencerMSU/clashbot-go/internal/config"
    "github.com/SpencerMSU/clashbot-go/pkg/logger"
)

func main() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    cfg, err := config.Load()
    if err != nil {
        logger.Fatalf("Failed to load config: %v", err)
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–≥–≥–µ—Ä
    logger.Init(cfg.LogLevel)
    
    logger.Info("üöÄ –ó–∞–ø—É—Å–∫ ClashBot Go...")
    
    // –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    clashBot, err := bot.New(cfg)
    if err != nil {
        logger.Fatalf("Failed to create bot: %v", err)
    }
    
    if err := clashBot.Start(); err != nil {
        logger.Fatalf("Bot error: %v", err)
        os.Exit(1)
    }
}
```

---

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. **–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã** (–ù–µ–¥–µ–ª—è 1-2)
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
mkdir clashbot-go && cd clashbot-go
go mod init github.com/SpencerMSU/clashbot-go

# –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
mkdir -p {cmd/bot,internal/{config,models,database,services,handlers,keyboards,bot,utils},pkg/logger,configs,migrations,docs,tests/{unit,integration}}

# –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
touch cmd/bot/main.go
touch internal/config/config.go
touch pkg/logger/logger.go
touch go.mod go.sum Makefile Dockerfile docker-compose.yml
```

### 2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** (–ù–µ–¥–µ–ª—è 2)
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
go get github.com/go-telegram-bot-api/telegram-bot-api/v5
go get gorm.io/gorm
go get gorm.io/driver/sqlite
go get gorm.io/driver/postgres
go get github.com/go-resty/resty/v2
go get github.com/spf13/viper
go get github.com/sirupsen/logrus
go get github.com/google/uuid
go get golang.org/x/time
go get github.com/stretchr/testify
```

### 3. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π** (–ù–µ–¥–µ–ª–∏ 3-20)
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –ø–æ –ø—Ä–∏–º–µ—Ä–∞–º –≤—ã—à–µ
- –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è
- –ü—Ä–æ–≤–µ—Å—Ç–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### 4. **–§–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** (–ù–µ–¥–µ–ª–∏ 21-26)
- –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –º–µ—Ç—Ä–∏–∫
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–≠—Ç–æ—Ç –ø–ª–∞–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ—ç—Ç–∞–ø–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π Python –±–æ—Ç–∞ –Ω–∞ Go —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ —É–ª—É—á—à–µ–Ω–∏–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.